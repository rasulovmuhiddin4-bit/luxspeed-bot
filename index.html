<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxspeed - Telegram Taksibot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #0088cc;
            --secondary: #00cc88;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 100%;
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .driver-header {
            background: linear-gradient(135deg, #ffcc00, #ff9900);
            color: #333;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .content {
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .welcome {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .welcome h2 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .driver-welcome h2 {
            color: #ff9900;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark);
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.2);
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 0;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-driver {
            background: linear-gradient(135deg, #ffcc00, #ff9900);
            color: #333;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .map-container {
            height: 200px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--gray);
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder {
            text-align: center;
        }
        
        .driver-info {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        
        .customer-info {
            background: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid var(--success);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .driver-tab.active {
            border-bottom: 3px solid #ff9900;
            color: #ff9900;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 90%;
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        .language-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .language-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .language-option.active {
            border-color: var(--primary);
            background: rgba(0, 136, 204, 0.1);
        }
        
        .payment-methods {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .payment-method {
            flex: 1;
            text-align: center;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .payment-method.active {
            border-color: var(--primary);
            background: rgba(0, 136, 204, 0.1);
        }
        
        .admin-alert {
            background: #ffebee;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid var(--danger);
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading i {
            font-size: 40px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .history-item {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        
        .order-item {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ff9900;
        }
        
        .admin-contact-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .admin-contact-card h3 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }
        
        .admin-contact-card p {
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .back-to-main {
            background: var(--gray);
            color: white;
            margin-top: 10px;
        }
        
        .card-payment-form {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #e9ecef;
        }
        
        .card-icons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        .card-icon {
            width: 50px;
            height: 30px;
            background: #fff;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1px solid #ddd;
        }
        
        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .star {
            font-size: 30px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .star.active {
            color: #ffcc00;
        }
        
        .order-status {
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-searching {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-accepted {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-arrived {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-completed {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }
        
        .driver-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .driver-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .location-info {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        
        .hidden {
            display: none;
        }
        
        .status-indicator {
            margin: 15px 0;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .driver-stats {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .navigation-buttons {
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <!-- Yuklash sahifasi -->
    <div class="container" id="loadingContainer">
        <div class="content">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <h3 id="loadingText">Yuklanmoqda...</h3>
            </div>
        </div>
    </div>

    <!-- Mijoz interfeysi -->
    <div class="container" id="customerContainer" style="display: none;">
        <div class="header">
            <div class="logo">
                <i class="fas fa-taxi"></i>
                Luxspeed Mijoz
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="order">Taksi chaqirish</div>
            <div class="tab" data-tab="active">Faol buyurtma</div>
            <div class="tab" data-tab="history">Tarix</div>
            <div class="tab" data-tab="admin">Admin</div>
            <div class="tab" data-tab="profile">Profil</div>
        </div>
        
        <div class="content">
            <!-- Taksi chaqirish -->
            <div class="tab-content active" id="order-tab">
                <div class="welcome">
                    <h2 id="customerWelcome">Taksi chaqirish</h2>
                    <p id="customerSubtitle">Quyidagi ma'lumotlarni to'ldiring</p>
                </div>
                
                <div class="form-group">
                    <label id="nameLabel">Ismingiz</label>
                    <input type="text" id="customerName" class="form-control" placeholder="Ismingizni kiriting">
                </div>
                
                <div class="form-group">
                    <label id="phoneLabel">Telefon raqamingiz</label>
                    <input type="tel" id="customerPhone" class="form-control" placeholder="+998 XX XXX XX XX">
                </div>
                
                <div class="form-group">
                    <label id="fromLabel">Qayerdan</label>
                    <input type="text" id="fromLocation" class="form-control" placeholder="Manzilingiz" value="Toshkent shahri">
                </div>
                
                <div class="form-group">
                    <label id="toLabel">Qayerga</label>
                    <input type="text" id="toLocation" class="form-control" placeholder="Yo'nalishingiz">
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method active" data-method="cash">
                        <i class="fas fa-money-bill-wave"></i>
                        <p id="cashLabel">Naqd pul</p>
                    </div>
                    <div class="payment-method" data-method="card">
                        <i class="fas fa-credit-card"></i>
                        <p id="cardLabel">Karta</p>
                    </div>
                </div>
                
                <!-- Karta to'lov formasi -->
                <div class="card-payment-form hidden" id="cardPaymentForm">
                    <h4 style="text-align: center; margin-bottom: 15px;">Karta ma'lumotlari</h4>
                    
                    <div class="card-icons">
                        <div class="card-icon" style="color: #00a8ff;">HUMO</div>
                        <div class="card-icon" style="color: #00a86b;">Uzcard</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Karta raqami</label>
                        <input type="text" id="cardNumber" class="form-control" placeholder="8600 1234 5678 9012" maxlength="19">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div class="form-group" style="flex: 1;">
                            <label>Amal qilish muddati</label>
                            <input type="text" id="cardExpiry" class="form-control" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>CVV</label>
                            <input type="text" id="cardCvv" class="form-control" placeholder="123" maxlength="3">
                        </div>
                    </div>
                </div>
                
                <div class="map-container">
                    <div class="map-placeholder">
                        <i class="fas fa-map-marker-alt" style="font-size: 40px; color: var(--primary);"></i>
                        <p id="mapText">Joylashuv xaritasi</p>
                        <small>GPS: 41.311081, 69.240562</small>
                    </div>
                </div>
                
                <button class="btn btn-success" id="orderBtn">
                    <i class="fas fa-taxi"></i>
                    <span id="orderText">Taksi chaqirish</span>
                </button>
                
                <button class="btn btn-secondary back-to-main" id="customerBackToMainBtn">
                    <i class="fas fa-home"></i>
                    <span>Asosiy menyuga qaytish</span>
                </button>
            </div>
            
            <!-- Faol buyurtma -->
            <div class="tab-content" id="active-tab">
                <div class="welcome">
                    <h2>Joriy buyurtma</h2>
                    <p>Buyurtma holatini kuzatishingiz mumkin</p>
                </div>
                
                <div class="order-status status-searching" id="orderStatus">
                    🚕 Haydovchi qidirilmoqda...
                </div>
                
                <div class="location-info">
                    <h4><i class="fas fa-map-marker-alt"></i> Manzil ma'lumotlari</h4>
                    <p><strong>Qayerdan:</strong> <span id="activeFromLocation">-</span></p>
                    <p><strong>Qayerga:</strong> <span id="activeToLocation">-</span></p>
                    <p><strong>Narx:</strong> <span id="activePrice">-</span></p>
                </div>
                
                <div class="driver-info hidden" id="driverInfo">
                    <div class="driver-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h4 id="assignedDriverName">Haydovchi</h4>
                        <p id="assignedDriverCar">Mashina: -</p>
                        <p id="assignedDriverPhone">Telefon: -</p>
                    </div>
                </div>
                
                <div class="map-container">
                    <div class="map-placeholder">
                        <i class="fas fa-car" style="font-size: 40px; color: var(--primary);"></i>
                        <p>Haydovchi yo'lda...</p>
                        <small>Kutilayotgan vaqt: 5-7 daqiqa</small>
                    </div>
                </div>
                
                <button class="btn btn-warning hidden" id="cancelOrderBtn">
                    <i class="fas fa-times"></i>
                    <span>Buyurtmani bekor qilish</span>
                </button>
            </div>
            
            <!-- Tarix -->
            <div class="tab-content" id="history-tab">
                <div class="welcome">
                    <h2 id="historyTitle">Buyurtmalar tarixi</h2>
                    <p id="historySubtitle">Oldingi safarlaringiz</p>
                </div>
                <div id="historyList">
                    <!-- Tarix bu yerda ko'rsatiladi -->
                </div>
            </div>
            
            <!-- Admin bilan aloqa -->
            <div class="tab-content" id="admin-tab">
                <div class="welcome">
                    <h2 id="adminTitle">Admin bilan aloqa</h2>
                    <p id="adminSubtitle">Savol va takliflaringiz bo'lsa</p>
                </div>
                
                <div class="admin-contact-card">
                    <i class="fas fa-headset" style="font-size: 50px; margin-bottom: 15px;"></i>
                    <h3>@Aloqa_admin1985</h3>
                    <p>Admin bilan bog'lanish uchun quyidagi tugmani bosing</p>
                    <button class="btn btn-info" id="contactAdminBtn">
                        <i class="fab fa-telegram"></i>
                        <span id="contactAdminText">Admin bilan bog'lanish</span>
                    </button>
                </div>
            </div>
            
            <!-- Profil -->
            <div class="tab-content" id="profile-tab">
                <div class="welcome">
                    <h2 id="profileTitle">Profil</h2>
                    <p id="profileSubtitle">Shaxsiy ma'lumotlaringiz</p>
                </div>
                
                <div class="driver-info">
                    <div class="driver-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h4 id="userName">Foydalanuvchi</h4>
                        <p id="userPhone">Telefon: -</p>
                        <p>Reyting: ⭐⭐⭐⭐⭐</p>
                    </div>
                </div>
                
                <div class="language-selector">
                    <div class="language-option active" data-lang="uz">
                        O'zbekcha
                    </div>
                    <div class="language-option" data-lang="ru">
                        Русский
                    </div>
                </div>
                
                <button class="btn btn-secondary back-to-main" id="backToMainBtn">
                    <i class="fas fa-home"></i>
                    <span id="backToMainText">Asosiy menyuga qaytish</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Haydovchi interfeysi -->
    <div class="container" id="driverContainer" style="display: none;">
        <div class="header driver-header">
            <div class="logo">
                <i class="fas fa-taxi"></i>
                Luxspeed Haydovchi
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab driver-tab active" data-tab="driver-profile">Profil</div>
            <div class="tab driver-tab" data-tab="driver-main">Ishni boshlash</div>
            <div class="tab driver-tab" data-tab="driver-active">Faol buyurtma</div>
            <div class="tab driver-tab" data-tab="driver-history">Tarix</div>
            <div class="tab driver-tab" data-tab="driver-admin">Admin</div>
        </div>
        
        <div class="content">
            <!-- Profil to'ldirish -->
            <div class="tab-content active" id="driver-profile-tab">
                <div class="welcome driver-welcome">
                    <h2>Profilni to'ldirish</h2>
                    <p>Ishni boshlash uchun profil ma'lumotlarini to'ldiring</p>
                </div>
                
                <div class="driver-info">
                    <div class="driver-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h4 id="driverProfileName">Haydovchi</h4>
                        <p id="driverProfileStatus">Holat: Profil to'ldirilmagan</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ism Familya</label>
                    <input type="text" id="driverFullName" class="form-control" placeholder="Ali Valiyev">
                </div>
                
                <div class="form-group">
                    <label>Telefon raqam</label>
                    <input type="tel" id="driverPhone" class="form-control" placeholder="+998 90 123 45 67">
                </div>
                
                <div class="form-group">
                    <label>Texpasport seriyasi</label>
                    <input type="text" id="techPassport" class="form-control" placeholder="AA 1234567">
                </div>
                
                <div class="form-group">
                    <label>Mashina modeli</label>
                    <input type="text" id="carModel" class="form-control" placeholder="Nexia 3">
                </div>
                
                <div class="form-group">
                    <label>Mashina raqami</label>
                    <input type="text" id="carNumber" class="form-control" placeholder="01 A 123 AA">
                </div>
                
                <div class="form-group">
                    <label>Mashina rangi</label>
                    <input type="text" id="carColor" class="form-control" placeholder="Oq">
                </div>
                
                <div class="form-group">
                    <label>Ish tajribasi</label>
                    <select id="driverExperience" class="form-control">
                        <option value="">Tajribani tanlang</option>
                        <option value="1">1 yil</option>
                        <option value="2">2 yil</option>
                        <option value="3">3 yil</option>
                        <option value="5">5 yil va undan ko'p</option>
                    </select>
                </div>
                
                <button class="btn btn-driver" id="saveDriverProfileBtn">
                    <i class="fas fa-save"></i>
                    Profilni saqlash
                </button>
                
                <div class="admin-alert">
                    <p><i class="fas fa-info-circle"></i> Profil ma'lumotlari to'liq to'ldirilgandan keyin ishni boshlashingiz mumkin</p>
                </div>
            </div>
            
            <!-- Ishni boshlash -->
            <div class="tab-content" id="driver-main-tab">
                <div class="welcome driver-welcome">
                    <h2>Ishni boshlash</h2>
                    <p>Mijozlar qidirishni boshlashingiz mumkin</p>
                </div>
                
                <div class="driver-info">
                    <div class="driver-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h4 id="activeDriverName">-</h4>
                        <p id="activeDriverCar">-</p>
                        <p id="activeDriverRating">Reyting: -</p>
                    </div>
                </div>
                
                <div class="location-info">
                    <h4><i class="fas fa-map-marker-alt"></i> Joylashuv</h4>
                    <p id="currentLocation">Yuklanmoqda...</p>
                    <button class="btn btn-primary" id="refreshLocationBtn">
                        <i class="fas fa-sync-alt"></i>
                        Joylashuvni yangilash
                    </button>
                </div>
                
                <div class="status-indicator">
                    <div class="status-online hidden" id="statusOnline">
                        <i class="fas fa-circle" style="color: var(--success);"></i>
                        <span>Onlayn - Mijozlar qidirilmoqda</span>
                    </div>
                    <div class="status-offline" id="statusOffline">
                        <i class="fas fa-circle" style="color: var(--gray);"></i>
                        <span>Offlayn</span>
                    </div>
                </div>
                
                <button class="btn btn-success" id="goOnlineBtn">
                    <i class="fas fa-play-circle"></i>
                    Onlayn bo'lish
                </button>
                
                <button class="btn btn-danger hidden" id="goOfflineBtn">
                    <i class="fas fa-stop-circle"></i>
                    Offlayn bo'lish
                </button>
                
                <div class="map-container">
                    <div class="map-placeholder">
                        <i class="fas fa-map-marker-alt" style="font-size: 40px; color: #ff9900;"></i>
                        <p>Joylashuv xaritasi</p>
                        <small id="gpsCoordinates">GPS: Yuklanmoqda...</small>
                    </div>
                </div>
            </div>
            
            <!-- Faol buyurtma -->
            <div class="tab-content" id="driver-active-tab">
                <div class="welcome driver-welcome">
                    <h2>Faol buyurtma</h2>
                    <p>Buyurtma bajarilishi</p>
                </div>
                
                <div class="order-status status-accepted" id="driverOrderStatus">
                    ✅ Buyurtma qabul qilindi
                </div>
                
                <div class="customer-info">
                    <h4><i class="fas fa-user"></i> Mijoz ma'lumotlari</h4>
                    <p><strong>Ism:</strong> <span id="activeCustomerName">-</span></p>
                    <p><strong>Telefon:</strong> <span id="activeCustomerPhone">-</span></p>
                    <p><strong>Manzil:</strong> <span id="activeCustomerLocation">-</span></p>
                    <p><strong>Yo'nalish:</strong> <span id="activeCustomerDestination">-</span></p>
                    <p><strong>Narx:</strong> <span id="activeOrderPrice">-</span></p>
                    <p><strong>To'lov usuli:</strong> <span id="activePaymentMethod">-</span></p>
                </div>
                
                <div class="map-container">
                    <div class="map-placeholder">
                        <i class="fas fa-road" style="font-size: 40px; color: #ff9900;"></i>
                        <p>Yo'nalish xaritasi</p>
                        <small id="tripDistance">Masofa: - | Vaqt: -</small>
                    </div>
                </div>
                
                <div class="driver-actions">
                    <button class="driver-action-btn" style="background: var(--success); color: white;" id="arrivedBtn">
                        <i class="fas fa-check"></i> Oldim
                    </button>
                    <button class="driver-action-btn" style="background: var(--warning); color: white;" id="startTripBtn">
                        <i class="fas fa-play"></i> Yo'lga chiqdim
                    </button>
                    <button class="driver-action-btn" style="background: var(--danger); color: white;" id="cancelTripBtn">
                        <i class="fas fa-times"></i> Bekor qilish
                    </button>
                </div>
                
                <div class="driver-actions hidden" id="tripActions">
                    <button class="driver-action-btn" style="background: var(--success); color: white;" id="completeTripBtn">
                        <i class="fas fa-flag-checkered"></i> Yakunlandi
                    </button>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-info" id="openNavigationBtn">
                        <i class="fas fa-map-marked-alt"></i>
                        Navigatsiyani ochish
                    </button>
                </div>
            </div>
            
            <!-- Tarix -->
            <div class="tab-content" id="driver-history-tab">
                <div class="welcome driver-welcome">
                    <h2>Buyurtmalar tarixi</h2>
                    <p>Bajarilgan buyurtmalar</p>
                </div>
                <div id="driverOrdersList">
                    <!-- Buyurtmalar bu yerda ko'rsatiladi -->
                </div>
            </div>
            
            <!-- Admin bilan aloqa -->
            <div class="tab-content" id="driver-admin-tab">
                <div class="welcome driver-welcome">
                    <h2>Admin bilan aloqa</h2>
                    <p>Savol va takliflaringiz bo'lsa</p>
                </div>
                
                <div class="admin-contact-card">
                    <i class="fas fa-headset" style="font-size: 50px; margin-bottom: 15px;"></i>
                    <h3>@Aloqa_admin1985</h3>
                    <p>Admin bilan bog'lanish uchun quyidagi tugmani bosing</p>
                    <button class="btn btn-info" id="driverContactAdminBtn">
                        <i class="fab fa-telegram"></i>
                        Admin bilan bog'lanish
                    </button>
                </div>
                
                <div class="driver-stats">
                    <h4>Statistika</h4>
                    <div class="stat-item">
                        <span>Bugungi buyurtmalar:</span>
                        <strong id="todayOrders">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Jami buyurtmalar:</span>
                        <strong id="totalOrders">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>O'rtacha reyting:</span>
                        <strong id="avgRating">-</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Baholash modali -->
    <div class="container hidden" id="ratingModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 90%; width: 400px; text-align: center;">
            <h3>Safar bahosi</h3>
            <p>Haydovchini baholang (1-5 yulduz)</p>
            
            <div class="rating-stars">
                <div class="star" data-rating="1">⭐</div>
                <div class="star" data-rating="2">⭐</div>
                <div class="star" data-rating="3">⭐</div>
                <div class="star" data-rating="4">⭐</div>
                <div class="star" data-rating="5">⭐</div>
            </div>
            
            <div class="form-group">
                <label>Izoh (ixtiyoriy)</label>
                <textarea id="ratingComment" class="form-control" placeholder="Izoh qoldiring..." rows="3"></textarea>
            </div>
            
            <button class="btn btn-success" id="submitRatingBtn">
                <i class="fas fa-star"></i>
                Bahoni yuborish
            </button>
        </div>
    </div>

    <script>
        // Telegram WebApp
        const tg = window.Telegram.WebApp;
        
        // Foydalanuvchi ma'lumotlari
        let userData = {
            id: null,
            role: null,
            language: 'uz',
            currentOrder: null,
            currentTrip: null
        };
        
        // Haydovchi ma'lumotlari
        let driverProfile = {
            isCompleted: false,
            fullName: '',
            phone: '',
            techPassport: '',
            carModel: '',
            carNumber: '',
            carColor: '',
            experience: '',
            location: null,
            isOnline: false
        };

        // Til matnlari
        const translations = {
            uz: {
                loading: "Yuklanmoqda...",
                customerWelcome: "Taksi chaqirish",
                customerSubtitle: "Quyidagi ma'lumotlarni to'ldiring",
                nameLabel: "Ismingiz",
                phoneLabel: "Telefon raqamingiz",
                fromLabel: "Qayerdan",
                toLabel: "Qayerga",
                cashLabel: "Naqd pul",
                cardLabel: "Karta",
                mapText: "Joylashuv xaritasi",
                orderText: "Taksi chaqirish",
                adminTitle: "Admin bilan aloqa",
                adminSubtitle: "Savol va takliflaringiz bo'lsa",
                contactAdminText: "Admin bilan bog'lanish",
                historyTitle: "Buyurtmalar tarixi",
                historySubtitle: "Oldingi safarlaringiz",
                profileTitle: "Profil",
                profileSubtitle: "Shaxsiy ma'lumotlaringiz",
                supportText: "Qo'llab-quvvatlash",
                backToMainText: "Asosiy menyuga qaytish",
                driverWelcome: "Haydovchi paneli",
                driverSubtitle: "Ishga tayyormisiz?",
                findCustomerText: "Mijoz qidirish",
                driverAdminTitle: "Admin bilan aloqa",
                driverAdminSubtitle: "Savol va takliflaringiz bo'lsa",
                driverContactAdminText: "Admin bilan bog'lanish",
                ordersTitle: "Buyurtmalar tarixi",
                ordersSubtitle: "Bajarilgan buyurtmalar",
                driverProfileTitle: "Profil",
                driverProfileSubtitle: "Shaxsiy ma'lumotlaringiz",
                driverSupportText: "Qo'llab-quvvatlash",
                driverBackToMainText: "Asosiy menyuga qaytish"
            },
            ru: {
                loading: "Загрузка...",
                customerWelcome: "Вызов такси",
                customerSubtitle: "Заполните следующие данные",
                nameLabel: "Ваше имя",
                phoneLabel: "Ваш телефон",
                fromLabel: "Откуда",
                toLabel: "Куда",
                cashLabel: "Наличные",
                cardLabel: "Карта",
                mapText: "Карта местоположения",
                orderText: "Вызвать такси",
                adminTitle: "Связь с админом",
                adminSubtitle: "Если у вас есть вопросы или предложения",
                contactAdminText: "Связаться с админом",
                historyTitle: "История заказов",
                historySubtitle: "Ваши предыдущие поездки",
                profileTitle: "Профиль",
                profileSubtitle: "Ваши личные данные",
                supportText: "Поддержка",
                backToMainText: "Вернуться в главное меню",
                driverWelcome: "Панель водителя",
                driverSubtitle: "Готовы к работе?",
                findCustomerText: "Поиск клиентов",
                driverAdminTitle: "Связь с админом",
                driverAdminSubtitle: "Если у вас есть вопросы или предложения",
                driverContactAdminText: "Связаться с админом",
                ordersTitle: "История заказов",
                ordersSubtitle: "Выполненные заказы",
                driverProfileTitle: "Профиль",
                driverProfileSubtitle: "Ваши личные данные",
                driverSupportText: "Поддержка",
                driverBackToMainText: "Вернуться в главное меню"
            }
        };

        // Dastur ishga tushganda
        document.addEventListener('DOMContentLoaded', function() {
            // Telegram WebApp mavjudligini tekshirish
            if (window.Telegram && window.Telegram.WebApp) {
                tg.ready();
                tg.expand();
                
                // URL parametrlarini o'qish
                const urlParams = new URLSearchParams(window.location.search);
                userData.id = urlParams.get('user_id') || tg.initDataUnsafe.user?.id;
                userData.role = urlParams.get('role') || 'customer';
                userData.language = urlParams.get('lang') || 'uz';
            } else {
                // Telegram WebApp mavjud bo'lmasa, test rejimida ishlash
                userData.id = 'test_user_' + Math.floor(Math.random() * 1000);
                userData.role = 'customer';
                userData.language = 'uz';
            }
            
            // Tilni sozlash
            setupLanguage();
            
            // Interfeysni yuklash
            loadInterface();
            
            // Event listenerlarni sozlash
            setupEventListeners();
            
            // Test ma'lumotlarni yuklash
            loadTestData();
        });

        // Tilni sozlash
        function setupLanguage() {
            applyTranslations();
        }

        // Tarjimalarni qo'llash
        function applyTranslations() {
            const lang = userData.language;
            const texts = translations[lang];
            
            for (const [key, value] of Object.entries(texts)) {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = value;
                }
            }
        }

        // Interfeysni yuklash
        function loadInterface() {
            const loadingContainer = document.getElementById('loadingContainer');
            const customerContainer = document.getElementById('customerContainer');
            const driverContainer = document.getElementById('driverContainer');
            
            // Yuklashni yashirish
            setTimeout(() => {
                loadingContainer.style.display = 'none';
                
                // Rolga qarab interfeysni ko'rsatish
                if (userData.role === 'customer') {
                    customerContainer.style.display = 'block';
                    setupCustomerInterface();
                } else if (userData.role === 'driver') {
                    driverContainer.style.display = 'block';
                    setupDriverInterface();
                } else {
                    // Agar rol aniqlanmagan bo'lsa, mijoz interfeysini ko'rsatish
                    customerContainer.style.display = 'block';
                    setupCustomerInterface();
                }
            }, 1500);
        }

        // Mijoz interfeysini sozlash
        function setupCustomerInterface() {
            // Foydalanuvchi ma'lumotlarini to'ldirish
            if (window.Telegram && window.Telegram.WebApp) {
                const user = tg.initDataUnsafe.user;
                if (user) {
                    document.getElementById('userName').textContent = user.first_name || 'Foydalanuvchi';
                    document.getElementById('customerName').value = user.first_name || '';
                    
                    if (user.username) {
                        document.getElementById('userPhone').textContent = `Telegram: @${user.username}`;
                    }
                }
            }
            
            // Tarixni yuklash
            loadHistory();
        }

        // Haydovchi interfeysini sozlash
        function setupDriverInterface() {
            // Haydovchi ma'lumotlarini to'ldirish
            if (window.Telegram && window.Telegram.WebApp) {
                const user = tg.initDataUnsafe.user;
                if (user) {
                    document.getElementById('driverProfileName').textContent = user.first_name || 'Haydovchi';
                    document.getElementById('driverFullName').value = user.first_name || '';
                    
                    if (user.username) {
                        document.getElementById('driverPhone').value = `+998${user.id.toString().slice(-9)}`;
                    }
                }
            }
            
            // GPS joylashuvni olish
            getCurrentLocation();
            
            // Profil holatini tekshirish
            checkDriverProfile();
            
            // Buyurtmalarni yuklash
            loadDriverOrders();
        }

        // Test ma'lumotlarni yuklash
        function loadTestData() {
            // GPS ma'lumotlari
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        console.log(`GPS: ${lat}, ${lng}`);
                    },
                    function(error) {
                        console.log('GPS xatosi:', error);
                    }
                );
            }
        }

        // GPS joylashuvni olish
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        
                        driverProfile.location = {
                            latitude: lat,
                            longitude: lng
                        };
                        
                        // Joylashuvni ko'rsatish
                        document.getElementById('gpsCoordinates').textContent = `GPS: ${lat}, ${lng}`;
                        document.getElementById('currentLocation').textContent = `Kenglik: ${lat}, Uzunlik: ${lng}`;
                        
                        // Manzil nomini olish (reverse geocoding)
                        getAddressFromCoordinates(lat, lng);
                    },
                    function(error) {
                        console.log('GPS xatosi:', error);
                        document.getElementById('gpsCoordinates').textContent = 'GPS: Xatolik';
                        document.getElementById('currentLocation').textContent = 'Joylashuvni olishda xatolik';
                        
                        // Test ma'lumotlari
                        driverProfile.location = {
                            latitude: '41.311081',
                            longitude: '69.240562'
                        };
                    }
                );
            } else {
                alert("GPS qo'llab-quvvatlanmaydi");
            }
        }

        // Koordinatalardan manzil olish
        function getAddressFromCoordinates(lat, lng) {
            // Bu yerda Google Maps API yoki boshqa geocoding servicedan foydalanish mumkin
            // Hozircha test ma'lumot
            const testAddresses = [
                "Toshkent shahri, Mirzo Ulug'bek tumani",
                "Toshkent shahri, Yunusobod tumani", 
                "Toshkent shahri, Chilonzor tumani",
                "Toshkent shahri, Shayxontohur tumani"
            ];
            
            const randomAddress = testAddresses[Math.floor(Math.random() * testAddresses.length)];
            document.getElementById('currentLocation').textContent = randomAddress;
        }

        // Profil holatini tekshirish
        function checkDriverProfile() {
            const savedProfile = localStorage.getItem('driverProfile');
            if (savedProfile) {
                driverProfile = JSON.parse(savedProfile);
                
                if (driverProfile.isCompleted) {
                    // Profil to'liq to'ldirilgan
                    document.getElementById('driverProfileStatus').textContent = 'Holat: Profil to\'ldirilgan';
                    document.getElementById('driverProfileStatus').style.color = 'var(--success)';
                    
                    // Ma'lumotlarni formaga to'ldirish
                    document.getElementById('driverFullName').value = driverProfile.fullName;
                    document.getElementById('driverPhone').value = driverProfile.phone;
                    document.getElementById('techPassport').value = driverProfile.techPassport;
                    document.getElementById('carModel').value = driverProfile.carModel;
                    document.getElementById('carNumber').value = driverProfile.carNumber;
                    document.getElementById('carColor').value = driverProfile.carColor;
                    document.getElementById('driverExperience').value = driverProfile.experience;
                    
                    // Ishni boshlash sahifasiga o'tish
                    switchToDriverMain();
                }
            }
        }

        // Profilni saqlash
        function saveDriverProfile() {
            const fullName = document.getElementById('driverFullName').value;
            const phone = document.getElementById('driverPhone').value;
            const techPassport = document.getElementById('techPassport').value;
            const carModel = document.getElementById('carModel').value;
            const carNumber = document.getElementById('carNumber').value;
            const carColor = document.getElementById('carColor').value;
            const experience = document.getElementById('driverExperience').value;
            
            // Validatsiya
            if (!fullName || !phone || !techPassport || !carModel || !carNumber || !carColor || !experience) {
                showNotification("Iltimos, barcha maydonlarni to'ldiring!", 'error');
                return;
            }
            
            // Texpasport formatini tekshirish
            if (!validateTechPassport(techPassport)) {
                showNotification("Texpasport seriyasi noto'g'ri formatda!", 'error');
                return;
            }
            
            // Telefon raqamini tekshirish
            if (!validatePhoneNumber(phone)) {
                showNotification("Telefon raqami noto'g'ri formatda!", 'error');
                return;
            }
            
            // Profilni saqlash
            driverProfile = {
                isCompleted: true,
                fullName: fullName,
                phone: phone,
                techPassport: techPassport,
                carModel: carModel,
                carNumber: carNumber,
                carColor: carColor,
                experience: experience,
                location: driverProfile.location,
                isOnline: false
            };
            
            localStorage.setItem('driverProfile', JSON.stringify(driverProfile));
            
            // Telegram botga ma'lumot yuborish
            if (window.Telegram && window.Telegram.WebApp) {
                tg.sendData(JSON.stringify({
                    action: 'update_driver_profile',
                    user_id: userData.id,
                    full_name: fullName,
                    phone: phone,
                    tech_passport: techPassport,
                    car_model: carModel,
                    car_number: carNumber,
                    car_color: carColor,
                    experience: experience
                }));
            }
            
            showNotification("Profil muvaffaqiyatli saqlandi! 🎉");
            
            // 2 soniyadan keyin asosiy sahifaga o'tish
            setTimeout(() => {
                switchToDriverMain();
            }, 2000);
        }

        // Ishni boshlash sahifasiga o'tish
        function switchToDriverMain() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="driver-main"]').classList.add('active');
            document.getElementById('driver-main-tab').classList.add('active');
            
            // Haydovchi ma'lumotlarini ko'rsatish
            document.getElementById('activeDriverName').textContent = driverProfile.fullName;
            document.getElementById('activeDriverCar').textContent = `${driverProfile.carModel} | ${driverProfile.carNumber}`;
            document.getElementById('activeDriverRating').textContent = 'Reyting: ⭐⭐⭐⭐☆ (4.2)';
        }

        // Onlayn bo'lish
        function goOnline() {
            if (!driverProfile.location) {
                showNotification("Iltimos, avval joylashuvni yangilang!", 'error');
                return;
            }
            
            driverProfile.isOnline = true;
            
            // Statusni yangilash
            document.getElementById('statusOnline').classList.remove('hidden');
            document.getElementById('statusOffline').classList.add('hidden');
            document.getElementById('goOnlineBtn').classList.add('hidden');
            document.getElementById('goOfflineBtn').classList.remove('hidden');
            
            // Telegram botga onlayn holatini yuborish
            if (window.Telegram && window.Telegram.WebApp) {
                tg.sendData(JSON.stringify({
                    action: 'driver_online',
                    user_id: userData.id,
                    latitude: driverProfile.location.latitude,
                    longitude: driverProfile.location.longitude,
                    car_model: driverProfile.carModel,
                    car_number: driverProfile.carNumber
                }));
            }
            
            showNotification("Onlayn holatdasiz! Mijozlar qidirilmoqda...");
            
            // Test: 10 soniyadan keyin buyurtma topildi deb ko'rsatish
            setTimeout(() => {
                simulateNewOrder();
            }, 10000);
        }

        // Offlayn bo'lish
        function goOffline() {
            driverProfile.isOnline = false;
            
            // Statusni yangilash
            document.getElementById('statusOnline').classList.add('hidden');
            document.getElementById('statusOffline').classList.remove('hidden');
            document.getElementById('goOnlineBtn').classList.remove('hidden');
            document.getElementById('goOfflineBtn').classList.add('hidden');
            
            // Telegram botga offlayn holatini yuborish
            if (window.Telegram && window.Telegram.WebApp) {
                tg.sendData(JSON.stringify({
                    action: 'driver_offline',
                    user_id: userData.id
                }));
            }
            
            showNotification("Offlayn holatdasiz", 'warning');
        }

        // Test buyurtma simulyatsiyasi
        function simulateNewOrder() {
            if (!driverProfile.isOnline) return;
            
            const testOrders = [
                {
                    customerName: "Ali Valiyev",
                    customerPhone: "+998901234567",
                    fromLocation: "Chorsu bozori",
                    toLocation: "Amir Temur maydoni",
                    price: "15,000 so'm",
                    paymentMethod: "Naqd pul",
                    distance: "3.2 km",
                    time: "12 daqiqa"
                },
                {
                    customerName: "Dilshod Rahimov", 
                    customerPhone: "+998901234568",
                    fromLocation: "Yunusobod 4-mavze",
                    toLocation: "Samarqand darvoza",
                    price: "12,000 so'm",
                    paymentMethod: "Karta",
                    distance: "2.8 km",
                    time: "10 daqiqa"
                },
                {
                    customerName: "Sardor Tursunov",
                    customerPhone: "+998901234569", 
                    fromLocation: "Xadra maydoni",
                    toLocation: "Havo terminali",
                    price: "25,000 so'm",
                    paymentMethod: "Naqd pul",
                    distance: "8.5 km", 
                    time: "20 daqiqa"
                }
            ];
            
            const randomOrder = testOrders[Math.floor(Math.random() * testOrders.length)];
            
            // Faol buyurtma sahifasiga o'tish
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="driver-active"]').classList.add('active');
            document.getElementById('driver-active-tab').classList.add('active');
            
            // Buyurtma ma'lumotlarini ko'rsatish
            document.getElementById('activeCustomerName').textContent = randomOrder.customerName;
            document.getElementById('activeCustomerPhone').textContent = randomOrder.customerPhone;
            document.getElementById('activeCustomerLocation').textContent = randomOrder.fromLocation;
            document.getElementById('activeCustomerDestination').textContent = randomOrder.toLocation;
            document.getElementById('activeOrderPrice').textContent = randomOrder.price;
            document.getElementById('activePaymentMethod').textContent = randomOrder.paymentMethod;
            document.getElementById('tripDistance').textContent = `Masofa: ${randomOrder.distance} | Vaqt: ${randomOrder.time}`;
            
            showNotification("✅ Yangi buyurtma topildi!", 'success');
        }

        // Validatsiya funksiyalari
        function validateTechPassport(passport) {
            // Texpasport formati: AA 1234567
            const regex = /^[A-Z]{2}\s\d{7}$/;
            return regex.test(passport);
        }

        function validatePhoneNumber(phone) {
            // O'zbekiston telefon raqami formati
            const regex = /^\+998\s?\d{2}\s?\d{3}\s?\d{2}\s?\d{2}$/;
            return regex.test(phone);
        }

        // Event listenerlarni sozlash
        function setupEventListeners() {
            // Tab o'zgartirish
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Barcha tab va kontentlarni yopish
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Faol tab va kontentni ko'rsatish
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // To'lov usulini tanlash
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    
                    const paymentMethod = this.getAttribute('data-method');
                    const cardForm = document.getElementById('cardPaymentForm');
                    
                    if (paymentMethod === 'card') {
                        cardForm.classList.remove('hidden');
                    } else {
                        cardForm.classList.add('hidden');
                    }
                });
            });
            
            // Tilni tanlash
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.language-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    
                    userData.language = this.getAttribute('data-lang');
                    applyTranslations();
                    showNotification("Til o'zgartirildi");
                });
            });
            
            // Taksi chaqirish
            document.getElementById('orderBtn').addEventListener('click', function() {
                createOrder();
            });
            
            // Mijoz qidirish
            document.getElementById('findCustomerBtn')?.addEventListener('click', function() {
                findCustomer();
            });
            
            // Admin bilan aloqa
            document.getElementById('contactAdminBtn').addEventListener('click', function() {
                contactAdmin();
            });
            
            document.getElementById('driverContactAdminBtn').addEventListener('click', function() {
                contactAdmin();
            });
            
            // Asosiy menyuga qaytish
            document.getElementById('backToMainBtn').addEventListener('click', function() {
                goToMainMenu();
            });
            
            document.getElementById('driverBackToMainBtn')?.addEventListener('click', function() {
                goToMainMenu();
            });
            
            document.getElementById('customerBackToMainBtn').addEventListener('click', function() {
                goToMainMenu();
            });
            
            document.getElementById('driverMainBackBtn')?.addEventListener('click', function() {
                goToMainMenu();
            });
            
            // Haydovchi harakatlari
            document.getElementById('arrivedBtn')?.addEventListener('click', function() {
                driverArrived();
            });
            
            document.getElementById('startTripBtn')?.addEventListener('click', function() {
                startTrip();
            });
            
            document.getElementById('completeTripBtn')?.addEventListener('click', function() {
                completeTrip();
            });
            
            document.getElementById('cancelTripBtn')?.addEventListener('click', function() {
                cancelTrip();
            });
            
            document.getElementById('cancelOrderBtn').addEventListener('click', function() {
                cancelOrder();
            });
            
            // Baholash
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = this.getAttribute('data-rating');
                    setRating(rating);
                });
            });
            
            document.getElementById('submitRatingBtn').addEventListener('click', function() {
                submitRating();
            });
            
            // Karta raqami formati
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    value = value.match(/.{1,4}/g).join(' ');
                }
                e.target.value = value;
            });
            
            // CVV formati
            document.getElementById('cardCvv').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 3);
            });
            
            // Amal qilish muddati formati
            document.getElementById('cardExpiry').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
            
            // Haydovchi event listenerlari
            document.getElementById('saveDriverProfileBtn')?.addEventListener('click', saveDriverProfile);
            document.getElementById('refreshLocationBtn')?.addEventListener('click', getCurrentLocation);
            document.getElementById('goOnlineBtn')?.addEventListener('click', goOnline);
            document.getElementById('goOfflineBtn')?.addEventListener('click', goOffline);
            document.getElementById('openNavigationBtn')?.addEventListener('click', function() {
                if (driverProfile.location) {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${driverProfile.location.latitude},${driverProfile.location.longitude}`;
                    window.open(url, '_blank');
                }
            });
        }

        // Buyurtma yaratish
        function createOrder() {
            const name = document.getElementById('customerName').value;
            const phone = document.getElementById('customerPhone').value;
            const from = document.getElementById('fromLocation').value;
            const to = document.getElementById('toLocation').value;
            const paymentMethod = document.querySelector('.payment-method.active').getAttribute('data-method');
            
            if (!name || !phone || !from || !to) {
                showNotification("Iltimos, barcha maydonlarni to'ldiring!", 'error');
                return;
            }
            
            // Karta to'lovini tekshirish
            if (paymentMethod === 'card') {
                const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                const cardExpiry = document.getElementById('cardExpiry').value;
                const cardCvv = document.getElementById('cardCvv').value;
                
                if (!validateCard(cardNumber, cardExpiry, cardCvv)) {
                    showNotification("Karta ma'lumotlari noto'g'ri! Iltimos, to'g'ri ma'lumotlar kiriting.", 'error');
                    return;
                }
            }
            
            showNotification("Buyurtmangiz qabul qilindi! Haydovchi topilmoqda...");
            
            // Faol buyurtma sahifasiga o'tish
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="active"]').classList.add('active');
            document.getElementById('active-tab').classList.add('active');
            
            // Buyurtma ma'lumotlarini ko'rsatish
            document.getElementById('activeFromLocation').textContent = from;
            document.getElementById('activeToLocation').textContent = to;
            document.getElementById('activePrice').textContent = "15,000 so'm";
            
            // Buyurtmani saqlash
            userData.currentOrder = {
                id: 'order_' + Date.now(),
                name: name,
                phone: phone,
                from: from,
                to: to,
                paymentMethod: paymentMethod,
                status: 'searching',
                price: '15000'
            };
            
            // Telegram botga ma'lumot yuborish
            if (window.Telegram && window.Telegram.WebApp) {
                tg.sendData(JSON.stringify({
                    action: 'create_order',
                    user_id: userData.id,
                    name: name,
                    phone: phone,
                    from: from,
                    to: to,
                    payment_method: paymentMethod,
                    language: userData.language,
                    price: '15000'
                }));
            }
            
            // 5 soniyadan keyin haydovchi topildi deb ko'rsatish (test)
            setTimeout(() => {
                document.getElementById('orderStatus').className = 'order-status status-accepted';
                document.getElementById('orderStatus').textContent = '✅ Haydovchi topildi!';
                document.getElementById('driverInfo').classList.remove('hidden');
                document.getElementById('cancelOrderBtn').classList.remove('hidden');
                
                // Test haydovchi ma'lumotlari
                document.getElementById('assignedDriverName').textContent = 'Akmal Joʻrayev';
                document.getElementById('assignedDriverCar').textContent = 'Mashina: Nexia 3 | 01 A 123 AA';
                document.getElementById('assignedDriverPhone').textContent = 'Telefon: +998901234567';
            }, 5000);
        }

        // Karta ma'lumotlarini tekshirish
        function validateCard(cardNumber, expiry, cvv) {
            // Karta raqami tekshirish (16 raqam)
            if (cardNumber.length !== 16) {
                return false;
            }
            
            // Amal qilish muddati (MM/YY)
            const expiryRegex = /^(0[1-9]|1[0-2])\/([0-9]{2})$/;
            if (!expiryRegex.test(expiry)) {
                return false;
            }
            
            // CVV tekshirish (3 raqam)
            if (cvv.length !== 3) {
                return false;
            }
            
            // Luhn algoritmi (oddiy versiya)
            let sum = 0;
            for (let i = 0; i < cardNumber.length; i++) {
                let digit = parseInt(cardNumber[i]);
                if (i % 2 === 0) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
            }
            
            return sum % 10 === 0;
        }

        // Mijoz qidirish
        function findCustomer() {
            showNotification("Mijozlar qidirilmoqda...");
            
            // Faol buyurtma sahifasiga o'tish
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="driver-active"]').classList.add('active');
            document.getElementById('driver-active-tab').classList.add('active');
            
            // Telegram botga so'rov yuborish
            if (window.Telegram && window.Telegram.WebApp) {
                tg.sendData(JSON.stringify({
                    action: 'find_customer',
                    user_id: userData.id,
                    language: userData.language
                }));
            }
            
            // Test ma'lumotlari
            userData.currentTrip = {
                customerName: "Ali Valiyev",
                customerPhone: "+998901234567",
                from: "Chorsu bozori",
                to: "Amir Temur maydoni",
                price: "15,000 so'm"
            };
        }

        // Haydovchi yetib keldi
        function driverArrived() {
            showNotification("Mijozga yetib keldigingizni bildirdingiz");
            document.getElementById('arrivedBtn').style.background = '#28a745';
        }

        // Safar boshlandi
        function startTrip() {
            showNotification("Safar boshlandi. Xavfsiz yo'l tilaymiz!");
            document.getElementById('startTripBtn').style.background = '#28a745';
            document.getElementById('tripActions').classList.remove('hidden');
        }

        // Safar yakunlandi
        function completeTrip() {
            showNotification("Safar muvaffaqiyatli yakunlandi!");
            
            // Baholash modali
            document.getElementById('ratingModal').classList.remove('hidden');
        }

        // Safar bekor qilindi
        function cancelTrip() {
            if (confirm("Safarni bekor qilishni xohlaysizmi?")) {
                showNotification("Safar bekor qilindi", 'warning');
                // Asosiy sahifaga qaytish
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="driver-main"]').classList.add('active');
                document.getElementById('driver-main-tab').classList.add('active');
            }
        }

        // Buyurtma bekor qilish
        function cancelOrder() {
            if (confirm("Buyurtmani bekor qilishni xohlaysizmi?")) {
                showNotification("Buyurtma bekor qilindi", 'warning');
                // Taksi chaqirish sahifasiga qaytish
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="order"]').classList.add('active');
                document.getElementById('order-tab').classList.add('active');
            }
        }

        // Baholash
        let selectedRating = 0;

        function setRating(rating) {
            selectedRating = rating;
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function submitRating() {
            if (selectedRating === 0) {
                showNotification("Iltimos, baho bering!", 'error');
                return;
            }

            const comment = document.getElementById('ratingComment').value;
            showNotification(`✅ ${selectedRating} yulduzli baho qo'yildi! Rahmat!`);
            
            // Baholash ma'lumotlarini yuborish
            if (window.Telegram && window.Telegram.WebApp) {
                tg.sendData(JSON.stringify({
                    action: 'submit_rating',
                    user_id: userData.id,
                    rating: selectedRating,
                    comment: comment,
                    driver_id: 'driver_123', // Test ma'lumot
                    order_id: userData.currentOrder?.id
                }));
            }
            
            // Modalni yopish va asosiy sahifaga qaytish
            document.getElementById('ratingModal').classList.add('hidden');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="order"]').classList.add('active');
            document.getElementById('order-tab').classList.add('active');
        }

        // Admin bilan aloqa
        function contactAdmin() {
            if (window.Telegram && window.Telegram.WebApp) {
                // Telegram WebApp orqali admin bilan bog'lanish
                tg.sendData(JSON.stringify({
                    action: 'contact_admin',
                    user_id: userData.id
                }));
                
                // Telegram kanaliga yo'naltirish
                tg.openTelegramLink('https://t.me/Aloqa_admin1985');
            } else {
                // Test rejimi
                window.open('https://t.me/Aloqa_admin1985', '_blank');
            }
            
            showNotification("Admin bilan bog'lanilmoqda...");
        }

        // Asosiy menyuga qaytish
        function goToMainMenu() {
            if (window.Telegram && window.Telegram.WebApp) {
                // WebApp ni yopish va botga qaytish
                tg.close();
            } else {
                // Test rejimi
                showNotification("Asosiy menyuga qaytish");
                // Bot manzilini o'zgartiring
                window.location.href = 'https://t.me/your_bot_username';
            }
        }

        // Xabarnoma ko'rsatish
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Tarixni yuklash
        function loadHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            // Test ma'lumotlari
            const testHistory = [
                { from: "Chorsu bozori", to: "Amir Temur maydoni", date: "2023-10-15 14:30", status: "completed", price: "15,000 so'm" },
                { from: "Toshkent markazi", to: "Havo terminali", date: "2023-10-10 09:15", status: "completed", price: "25,000 so'm" },
                { from: "Yunusobod", to: "Mirzo Ulug'bek", date: "2023-10-05 18:45", status: "completed", price: "12,000 so'm" }
            ];
            
            historyList.innerHTML = '';
            
            testHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <h4>${item.from} → ${item.to}</h4>
                    <p>Sana: ${item.date}</p>
                    <p>Narx: ${item.price}</p>
                    <p>Holat: ${item.status === 'completed' ? 'Bajarildi' : 'Faol'}</p>
                `;
                historyList.appendChild(historyItem);
            });
        }
        
        // Haydovchi buyurtmalarini yuklash
        function loadDriverOrders() {
            const ordersList = document.getElementById('driverOrdersList');
            if (!ordersList) return;
            
            // Test ma'lumotlari
            const testOrders = [
                { from: "Chorsu bozori", to: "Amir Temur maydoni", date: "2023-10-15 14:30", price: "15,000 so'm", rating: 5 },
                { from: "Toshkent markazi", to: "Havo terminali", date: "2023-10-10 09:15", price: "25,000 so'm", rating: 4 },
                { from: "Yunusobod", to: "Mirzo Ulug'bek", date: "2023-10-05 18:45", price: "12,000 so'm", rating: 5 }
            ];
            
            ordersList.innerHTML = '';
            
            testOrders.forEach(item => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                orderItem.innerHTML = `
                    <h4>${item.from} → ${item.to}</h4>
                    <p>Sana: ${item.date}</p>
                    <p>Narx: ${item.price}</p>
                    <p>Baholash: ${'⭐'.repeat(item.rating)}</p>
                `;
                ordersList.appendChild(orderItem);
            });
        }

        // Telegram WebApp dan kelgan ma'lumotlarni qayta ishlash
        if (window.Telegram && window.Telegram.WebApp) {
            tg.onEvent('viewportChanged', function() {
                tg.expand();
            });
        }
    </script>
</body>
</html>